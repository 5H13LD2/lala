rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ðŸ”¹ Users Collection
    match /users/{userId} {
      // Allow all authenticated users to READ any user profile (for leaderboard)
      // But only allow users to WRITE to their own profile
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;

      // ðŸ”¹ Achievements subcollection (user-specific unlocked achievements)
      match /achievements/{achievementId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Quiz Scores subcollection under users
      match /quiz_scores/{moduleId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;

        // ðŸ”¹ Attempts subcollection inside each quiz score
        match /attempts/{attemptId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }

      // Quiz Results subcollection under users
      match /quizResults/{resultId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ðŸ”¹ Global Achievements Collection (template list of all achievements)
    match /achievements/{achievementId} {
      allow read: if true;                     // anyone can read available achievements
      allow write: if request.auth.token.admin == true; // only admin can modify global achievements
    }

    // ðŸ”¹ User Progress Collection (for tracking lesson completion and technical assessments)
    match /user_progress/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // ðŸ”¹ Technical Assessment Progress subcollection (for both Python and SQL)
      match /technical_assessment_progress/{challengeId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Courses subcollection under user_progress
      match /courses/{courseId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;

        // Modules subcollection under courses
        match /modules/{moduleId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
    }

    // ðŸ”¹ Courses Collection
    match /courses/{courseId} {
      allow read: if true;
      allow write: if request.auth != null;

      // Modules subcollection
      match /modules/{moduleId} {
        allow read: if true;
        allow write: if request.auth != null;

        // Lessons subcollection under modules
        match /lessons/{lessonId} {
          allow read: if true;
          allow write: if request.auth != null;
        }
      }
    }

    // ðŸ”¹ Quizzes Collection (Global)
    match /course_quiz/{quizId} {
      allow read: if true;
      allow write: if request.auth != null;

      // Questions subcollection under each quiz
      match /questions/{questionId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
    }

    // ðŸ”¹ Leaderboard Collection
    match /leaderboard/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // ðŸ”¹ Technical Assessments (Challenge Definitions)
    match /technical_assesment/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.admin == true;
    }
    
    // ðŸ”¹ Feedback Collection
    match /feedback/{feedbackId} {
      // Allow authenticated users to create feedback with required fields
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['feedback', 'timestamp', 'userId', 'userEmail', 'username', 'deviceInfo', 'appVersion', 'status'])
                    && request.resource.data.feedback is string
                    && request.resource.data.feedback.size() > 0
                    && request.resource.data.feedback.size() <= 1000
                    && request.resource.data.userEmail is string
                    && request.resource.data.username is string
                    && request.resource.data.deviceInfo is string
                    && request.resource.data.appVersion is string
                    && request.resource.data.status is string;

      // Allow users to read only their own feedback
      allow read: if request.auth != null
                  && resource.data.userId == request.auth.uid;

      // Only admins can update/delete feedback
      allow update, delete: if request.auth != null
                            && request.auth.token.admin == true;
    }

    // ðŸ”¹ Test Collection (for dev/debugging)
    match /test/{docId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // ðŸ”¹ Catch-all deny (safety net)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
